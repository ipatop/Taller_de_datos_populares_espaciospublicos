---
title: "Descarga de Features"
author: "TDP-EP"
author: "Ari e Ine"
date: "9/13/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Objetivos

En este notebook vamos a empezar tomar los parques de OSM filtrados por área (2.5% ha) y vamos a buscar datos de sus _features_.

Los features de interés son:

- Paradas de colectivo
- Juegos de niños
- Perrera
- ...?

## Carga de parquecitos

```{r}
require(tidyverse)
require(ggplot2)
require(patchwork)
require(leaflet)
require(osmdata)
require(htmlwidgets)
require(sf)
require(ggmap)
require(lwgeom)
```

Cargamos los parques desde OSM

```{r}
  bb = getbb('Ciudad Autonoma de Buenos Aires, Argentina',format_out = 'polygon')
  bbox_ba = getbb("Ciudad Autonoma de Buenos Aires, Argentina")
  ciudad = st_polygon(list(bb[[2]][[1]]))
  ciudad = st_sfc(ciudad)
if(file.exists('parquesCorteArea2_5perc.geojson')){
  parksOSM = st_read('parquesCorteArea2_5perc.geojson')
}else{
  parks = opq(bb) %>% 
  add_osm_feature(key = 'leisure', value = "park") %>% 
  osmdata_sf() %>% trim_osmdata(bb)


  parks_poly = parks$osm_polygons
  parks_mpoly = parks$osm_multipolygons
  cn = intersect(colnames(parks_poly),colnames(parks_mpoly))
  #cn
  parksOSM = rbind(parks_poly[,cn],parks_mpoly[,cn])
  
  parksOSM = st_transform(parksOSM,crs=22195)
  
  parksOSM = st_make_valid(parksOSM)
  
  parksOSM$area = as.numeric(st_area(parksOSM))
  parksOSM$perimeter = as.numeric(st_perimeter(parksOSM))
  parksOSM$ASP = parksOSM$area/parksOSM$perimeter
  
  
  parksOSM = parksOSM %>% filter(area/100**2>2.5/100)
  st_write(parksOSM,'parquesCorteArea2_5perc.geojson')
}
```
Checkeo rápido de que esté en orden el mapa:

```{r}
parksOSM  %>% ggplot() + geom_sf()
```


## Paradas de colectivo

Las paradas de colectivo se identifican con `key="public_transport"` y `value="stop_position"`.
```{r}
paradas_ba <- opq(bb) %>%
                    add_osm_feature(key = "public_transport", value = "stop_position") %>%
  osmdata_sf() %>% trim_osmdata(bb) 

paradas_ba = paradas_ba$osm_points
```

```{r}
paradas_ba  %>% ggplot() + geom_sf()
```

Ahora vamos a buscar cuantos, fijado un radio, están a cierta distancia:

```{r}
D = st_distance(parksOSM,paradas_ba %>% st_transform(crs=st_crs(parksOSM)))
```
```{r}
f = function(radio) apply(D,1,function(x) sum(x<=radio))

parksOSM = parksOSM %>% mutate(radio0m = f(0), radio100m = f(100),radio200m=f(200),radio500m=f(500),radio1000m=f(1000))
```


Para chusmear cuantos hay en cada clase
```{r}
parksOSM$radio0m %>% hist(breaks=0:10-.5,xlab='Cantidad de paradas de colectivo a 0m')
parksOSM$radio100m %>% hist(breaks=0:50-.5,xlab='Cantidad de paradas de colectivo a 100m')
parksOSM$radio200m %>% hist(breaks=0:100-.5,xlab='Cantidad de paradas de colectivo a 200m')
parksOSM$radio500m %>% hist(breaks=0:500-.5,xlab='Cantidad de paradas de colectivo a 500m')
parksOSM$radio1000m %>% hist(breaks=0:500-.5,xlab='Cantidad de paradas de colectivo a 1000m')
```

Viendolo me quedaría con `200m`